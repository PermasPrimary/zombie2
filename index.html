import React, { useState, useEffect } from 'react';

const ZombieGame = () => {
  const [score, setScore] = useState(0);
  const [lives, setLives] = useState(3);
  const [gameOver, setGameOver] = useState(false);
  const [zombies, setZombies] = useState([]);
  const [currentQuestion, setCurrentQuestion] = useState(null);
  const [answerGenerated, setAnswerGenerated] = useState(false);
  const [questionCount, setQuestionCount] = useState(0);
  const [level, setLevel] = useState(1);
  
  // æ¯å…³ç­”å¯¹10é¢˜
  const QUESTIONS_PER_LEVEL = 10;
  
  // å°†å±å¹•æ¨ªå‘åˆ’åˆ†ä¸º6ä¸ªåŒºåŸŸï¼Œç¡®ä¿åƒµå°¸ä¸ä¼šé‡å 
  const POSITION_ZONES = [
    { min: 5, max: 20 },
    { min: 25, max: 35 },
    { min: 40, max: 50 },
    { min: 55, max: 65 },
    { min: 70, max: 80 },
    { min: 85, max: 95 }
  ];
  
  // è¯åº“ï¼š[é©¬æ¥æ–‡, ä¸­æ–‡] æ ¼å¼
  const wordBank = [
    ['memerlukan', 'éœ€è¦'],
    ['lauk-pauk', 'èœè‚´'],
    ['kegemaran', 'å–œæ¬¢çš„'],
    ['bergerak', 'ç§»åŠ¨'],
    ['pengetahuan', 'çŸ¥è¯†'],
    ['penyabar', 'æœ‰è€å¿ƒçš„'],
    ['merawat', 'æ²»ç–—'],
    ['panggil', 'å«'],
    ['lemau', 'çš®äº†'],
    ['gopoh', 'åŒ†å¿™'],
    ['memainkan', 'æ‰®æ¼”'],
    ['mencabut', 'æ‹”é™¤'],
    ['pengalaman', 'ç»éªŒ'],
    ['perpustakaan', 'å›¾ä¹¦é¦†'],
    ['mendaftarkan', 'æ³¨å†Œ'],
    ['kaedah', 'æ–¹æ³•'],
    ['sebenarnya', 'äº‹å®ä¸Š'],
    ['selidik', 'è°ƒæŸ¥'],
    ['peluang', 'æœºä¼š'],
    ['pandangan', 'æ„è§']
  ];

  // è·å–éšæœºä½ç½®åŒºåŸŸ
  const getRandomPosition = (usedPositions) => {
    const availableZones = POSITION_ZONES.filter((_, index) => 
      !usedPositions.includes(index)
    );
    if (availableZones.length === 0) return null;
    
    const randomZone = availableZones[Math.floor(Math.random() * availableZones.length)];
    const position = Math.random() * (randomZone.max - randomZone.min) + randomZone.min;
    return {
      position,
      zoneIndex: POSITION_ZONES.indexOf(randomZone)
    };
  };

  // ç”Ÿæˆæ–°é—®é¢˜
  const generateQuestion = () => {
    const randomPair = wordBank[Math.floor(Math.random() * wordBank.length)];
    setAnswerGenerated(false);
    return {
      malay: randomPair[0],
      chinese: randomPair[1]
    };
  };

  // ç”Ÿæˆæ–°åƒµå°¸
  const generateZombie = (forceAnswer = false) => {
    const usedPositions = zombies.map(z => z.zoneIndex);
    const positionData = getRandomPosition(usedPositions);
    
    if (!positionData) return null; // å¦‚æœæ²¡æœ‰å¯ç”¨ä½ç½®ï¼Œä¸ç”Ÿæˆåƒµå°¸

    if (forceAnswer || (!answerGenerated && currentQuestion)) {
      setAnswerGenerated(true);
      return {
        id: Date.now(),
        word: currentQuestion.malay,
        isAnswer: true,
        position: positionData.position,
        zoneIndex: positionData.zoneIndex,
        top: -50
      };
    } else {
      let randomPair;
      do {
        randomPair = wordBank[Math.floor(Math.random() * wordBank.length)];
      } while (currentQuestion && randomPair[0] === currentQuestion.malay);
      
      return {
        id: Date.now(),
        word: randomPair[0],
        isAnswer: false,
        position: positionData.position,
        zoneIndex: positionData.zoneIndex,
        top: -50
      };
    }
  };

  // å¼€å§‹æ–°æ¸¸æˆæˆ–æ–°å…³å¡
  const startNewLevel = () => {
    setZombies([]);
    setAnswerGenerated(false);
    setCurrentQuestion(generateQuestion());
  };

  const startNewGame = () => {
    setScore(0);
    setLives(3);
    setGameOver(false);
    setQuestionCount(0);
    setLevel(1);
    startNewLevel();
  };

  // æ¸¸æˆåˆå§‹åŒ–
  useEffect(() => {
    startNewGame();
  }, []);

  // å®šæœŸç”Ÿæˆåƒµå°¸
  useEffect(() => {
    if (gameOver) return;
    
    // ç«‹å³ç”Ÿæˆæ­£ç¡®ç­”æ¡ˆçš„åƒµå°¸
    if (!answerGenerated && currentQuestion) {
      const zombie = generateZombie(true);
      if (zombie) {
        setZombies(prev => [...prev, zombie]);
      }
    }
    
    const interval = setInterval(() => {
      const zombie = generateZombie();
      if (zombie) {
        setZombies(prev => [...prev, zombie]);
      }
    }, 2000);

    return () => clearInterval(interval);
  }, [gameOver, currentQuestion, answerGenerated]);

  // åƒµå°¸ç§»åŠ¨
  useEffect(() => {
    if (gameOver) return;

    const moveInterval = setInterval(() => {
      setZombies(prev => {
        const newZombies = prev.map(zombie => ({
          ...zombie,
          top: zombie.top + 1.5
        })).filter(zombie => zombie.top < window.innerHeight - 100);

        if (prev.length > newZombies.length) {
          setLives(lives => {
            const newLives = lives - 1;
            if (newLives <= 0) {
              setGameOver(true);
            }
            return newLives;
          });
        }

        return newZombies;
      });
    }, 50);

    return () => clearInterval(moveInterval);
  }, [gameOver]);

  // ç‚¹å‡»åƒµå°¸
  const handleClick = (zombie) => {
    if (gameOver) return;

    if (zombie.isAnswer) {
      setScore(score + 1);
      setQuestionCount(prev => {
        const newCount = prev + 1;
        if (newCount >= QUESTIONS_PER_LEVEL) {
          // å®Œæˆå½“å‰å…³å¡
          setLevel(level + 1);
          setQuestionCount(0);
          startNewLevel();
        } else {
          setCurrentQuestion(generateQuestion());
        }
        return newCount;
      });
    } else {
      setLives(lives => {
        const newLives = lives - 1;
        if (newLives <= 0) {
          setGameOver(true);
        }
        return newLives;
      });
    }
    
    setZombies(prev => prev.filter(z => z.id !== zombie.id));
  };

  return (
    <div className="relative h-screen w-full bg-gray-900 overflow-hidden">
      {/* çŠ¶æ€æ  */}
      <div className="absolute top-0 left-0 right-0 p-4 flex justify-between bg-gray-800 text-white">
        <div className="flex space-x-8">
          <div>ç¬¬ {level} å…³</div>
          <div>é¢˜ç›®: {questionCount}/{QUESTIONS_PER_LEVEL}</div>
          <div>åˆ†æ•°: {score}</div>
        </div>
        <div>ç”Ÿå‘½å€¼: {'â¤ï¸'.repeat(lives)}</div>
      </div>

      {/* å½“å‰é¢˜ç›® */}
      <div className="absolute top-20 left-0 right-0 text-center text-white text-2xl font-bold bg-gray-800 bg-opacity-75 py-4">
        è¯·é€‰æ‹©"{currentQuestion?.chinese}"çš„é©¬æ¥æ–‡
      </div>

      {/* åƒµå°¸ */}
      {zombies.map(zombie => (
        <div
          key={zombie.id}
          className="absolute cursor-pointer transition-transform hover:scale-110"
          style={{
            left: `${zombie.position}%`,
            top: zombie.top,
          }}
          onClick={() => handleClick(zombie)}
        >
          <div className="bg-green-700 p-2 rounded-lg shadow-lg">
            <span className="text-white font-bold">{zombie.word}</span>
          </div>
          <div className="text-4xl">ğŸ§Ÿ</div>
        </div>
      ))}

      {/* æ¸¸æˆç»“æŸå¯¹è¯æ¡† */}
      {gameOver && (
        <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
          <div className="bg-white p-8 rounded-lg text-center">
            <h2 className="text-2xl font-bold mb-4">æ¸¸æˆç»“æŸ!</h2>
            <p className="mb-2">æœ€ç»ˆå¾—åˆ†: {score}</p>
            <p className="mb-4">è¾¾åˆ°ç¬¬ {level} å…³</p>
            <button
              onClick={startNewGame}
              className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
            >
              é‡æ–°å¼€å§‹
            </button>
          </div>
        </div>
      )}

      {/* æ¸¸æˆè¯´æ˜ */}
      <div className="absolute bottom-4 left-4 text-white text-sm">
        <p>ç‚¹å‡»å¯¹åº”é¢˜ç›®çš„é©¬æ¥æ–‡åƒµå°¸å¾—åˆ†</p>
        <p>æ¯å…³éœ€ç­”å¯¹10é¢˜æ‰èƒ½è¿›å…¥ä¸‹ä¸€å…³</p>
        <p>ç‚¹é”™æˆ–è®©åƒµå°¸è§¦åº•éƒ½ä¼šæ‰£ç”Ÿå‘½å€¼</p>
        <p>ä¸‰æ¬¡å¤±è¯¯åæ¸¸æˆç»“æŸ</p>
      </div>
    </div>
  );
};

export default ZombieGame;
